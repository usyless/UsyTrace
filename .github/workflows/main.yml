name: Build and push latest main to pages

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repo
      uses: actions/checkout@v4
      with:
        path: usytrace
        ref: main
        persist-credentials: false

    - name: Check if imageTracer.cpp changed
      uses: dorny/paths-filter@v3
      id: changes
      with:
        working-directory: usytrace
        filters: |
          imageTracer:
            - 'src/imageTracer.cpp'

    - name: Set up Emscripten
      run: |
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        git pull
        ./emsdk install latest
        ./emsdk activate latest

    - name: Build WASM
      if: steps.changes.outputs.imageTracer == 'true'
      run: |
        source ./emsdk/emsdk_env.sh
        cd ./usytrace/src
        emcc imageTracer.cpp -O3 -sWASM=1 -sALLOW_MEMORY_GROWTH=1 -sEXPORTED_RUNTIME_METHODS=cwrap -sINITIAL_HEAP=104857600 -sASSERTIONS=0 -sFILESYSTEM=0 -sENVIRONMENT=worker -fno-rtti -flto -g0 -fno-exceptions --closure 1 --closure-args=--compilation_level=SIMPLE --post-js worker.js

    - name: Minify files
      run: |
        source ./emsdk/emsdk_env.sh
        cd ./usytrace/src
        echo "JAVA_HOME=${{ env.JAVA_HOME_21_X64 }}" >> $GITHUB_ENV
        
        java -jar "$EMSDK/upstream/emscripten/node_modules/google-closure-compiler-java/compiler.jar" --language_in=ECMASCRIPT_2020 --language_out=ECMASCRIPT_2020 --js main.js popups.js tutorial.js about.js updater.js --js_output_file main.min.js

    - name: Checkout github pages repo
      uses: actions/checkout@v4
      with:
        repository: usyless/usyless.github.io
        token: ${{ secrets.BOT_TOKEN }}
        path: usyless.github.io
        ref: main
        persist-credentials: true

    - name: Move built files to pages repo
      run: |
        cp -rf usytrace/src/* usyless.github.io/trace/
        cd usyless.github.io/trace
        rm -f imageTracer.cpp
        rm -f about.js
        rm -f main.js
        rm -f worker.js
        rm -f updater.js
        rm -f tutorial.js
        rm -f popups.js
    
    - name: Commit and push
      working-directory: usyless.github.io
      run: |
        git config --global user.name 'usy [github actions]'
        git config --global user.email 'github-actions@github.com'
        git add trace
        git commit -m 'Update trace from usytrace'
        git push
